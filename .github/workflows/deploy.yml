name: Deploy Static Site to GitHub Pages

on:
  push:
    branches:
      - main  # Triggers on push to main branch
  workflow_dispatch:  # Allows manual trigger from Actions tab

# Sets permissions for GitHub token
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate HTML files
        run: |
          echo "Validating HTML files..."
          # Check that all required HTML files exist
          required_files=("index.html" "about.html" "engineering.html" "energy.html" "faq.html" "contact.html" "404.html")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Error: Required file $file not found!"
              exit 1
            else
              echo "✅ Found: $file"
            fi
          done

      - name: Check for broken links
        run: |
          echo "Checking for broken internal links..."
          # Simple grep-based link checker for internal links
          for file in *.html; do
            echo "Checking links in $file..."
            # Extract href attributes and check if referenced files exist
            grep -o 'href="[^"]*\.html"' "$file" | sed 's/href="//;s/"$//' | while read link; do
              if [ ! -f "$link" ]; then
                echo "⚠️  Warning: $file references missing file: $link"
              fi
            done
          done

      - name: Verify meta tags
        run: |
          echo "Verifying SEO meta tags..."
          for file in *.html; do
            echo "Checking $file..."
            # Check for essential meta tags
            if ! grep -q 'meta name="description"' "$file"; then
              echo "⚠️  Warning: $file missing description meta tag"
            fi
            if ! grep -q 'og:title' "$file"; then
              echo "⚠️  Warning: $file missing Open Graph title"
            fi
            if ! grep -q 'twitter:card' "$file"; then
              echo "⚠️  Warning: $file missing Twitter Card meta"
            fi
          done

      - name: Check Bootstrap and jQuery assets
        run: |
          echo "Verifying CSS and JavaScript assets..."
          if [ ! -f "assets/css/bootstrap.min.united.css" ]; then
            echo "❌ Error: Bootstrap CSS not found!"
            exit 1
          fi
          if [ ! -f "assets/js/jquery.min.js" ]; then
            echo "❌ Error: jQuery not found!"
            exit 1
          fi
          if [ ! -f "assets/js/bootstrap.min.js" ]; then
            echo "❌ Error: Bootstrap JS not found!"
            exit 1
          fi
          echo "✅ All required assets found"

      - name: Verify CNAME file
        run: |
          if [ ! -f "CNAME" ]; then
            echo "❌ Error: CNAME file not found!"
            exit 1
          fi
          if [ "$(cat CNAME)" != "aceengineer.com" ]; then
            echo "❌ Error: CNAME file contains incorrect domain!"
            exit 1
          fi
          echo "✅ CNAME file verified: aceengineer.com"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'  # Upload entire repository (static site)

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment success notification
        run: |
          echo "✅ Deployment successful!"
          echo "Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Custom domain: https://aceengineer.com"
